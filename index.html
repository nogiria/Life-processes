<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Processes | Ranker - Karun Madhav S.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        let db, auth, user;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'life-processes-ranker';
        const firebaseConfig = JSON.parse(__firebase_config);

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Auth Logic - Following Rule 3 (Auth Before Queries)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth initialization failed", err);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                fetchLeaderboard();
            }
        });

        // Initialize auth on load
        initAuth();

        // Leaderboard Logic - Following Rule 1 (Strict Paths)
        function fetchLeaderboard() {
            if (!user) return;
            const lbRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            
            onSnapshot(lbRef, (snapshot) => {
                const entries = [];
                snapshot.forEach(doc => entries.push(doc.data()));
                entries.sort((a, b) => b.score - a.score || a.timeSeconds - b.timeSeconds);
                renderLeaderboardUI(entries);
            }, (err) => {
                console.error("Leaderboard Error:", err);
            });
        }

        function renderLeaderboardUI(entries) {
            const container = document.getElementById('leaderboard-list');
            if (!container) return;
            container.innerHTML = entries.length ? '' : '<p class="text-gray-600 italic">No rankings yet.</p>';
            entries.slice(0, 5).forEach((entry, i) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/10 mb-2";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-neon-green font-bold">#${i + 1}</span>
                        <span class="text-sm font-medium text-white">${entry.name}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-neon-green font-bold">${entry.score}/25</p>
                        <p class="text-[10px] text-gray-500">${entry.timeFormatted}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.submitToLeaderboard = async (name, score, timeSec, timeStr) => {
            if (!user) return;
            try {
                const lbRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                await addDoc(lbRef, {
                    name: name,
                    score: score,
                    timeSeconds: timeSec,
                    timeFormatted: timeStr,
                    timestamp: Date.now(),
                    uid: user.uid
                });
            } catch (e) {
                console.error("Error adding score: ", e);
            }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --neon-green: #39FF14;
            --dark-bg: #020202;
            --deep-green: #0a1f0a;
        }

        body {
            background-color: var(--dark-bg);
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .neon-text {
            color: var(--neon-green);
            text-shadow: 0 0 15px rgba(57, 255, 20, 0.6);
            font-family: 'Orbitron', sans-serif;
        }

        .bio-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, var(--deep-green) 0%, var(--dark-bg) 100%);
        }

        .leaf-pattern {
            position: absolute;
            width: 200%;
            height: 200%;
            opacity: 0.08;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cpath d='M60 10 C 30 40 30 70 60 110 C 90 70 90 40 60 10 M60 10 L60 110 M60 40 L40 55 M60 60 L80 75 M60 80 L45 95' stroke='%2339FF14' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
            animation: drift 60s linear infinite;
        }

        @keyframes drift {
            from { transform: translate(-25%, -25%) rotate(0deg); }
            to { transform: translate(0%, 0%) rotate(5deg); }
        }

        .glass-card {
            background: rgba(10, 10, 10, 0.85);
            border: 1px solid rgba(57, 255, 20, 0.15);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .btn-start {
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            padding: 1rem 3rem;
            font-family: 'Orbitron';
            font-weight: bold;
            transition: all 0.4s;
            cursor: pointer;
            position: relative;
        }

        .btn-start:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 40px var(--neon-green);
            transform: scale(1.05);
        }

        .palette-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #222;
        }
        .palette-btn.active { border: 2px solid var(--neon-green); }
        .palette-btn.answered { background: #064e06; color: var(--neon-green); }

        .option-card {
            border: 1px solid #1a1a1a;
            background: rgba(255,255,255,0.02);
            transition: 0.2s;
        }
        .option-card.selected { border-color: var(--neon-green); background: rgba(57, 255, 20, 0.1); }

        #exam-ui, #results-screen, #name-modal { display: none; }
    </style>
</head>
<body>
    <div class="bio-overlay"></div>
    <div class="leaf-pattern"></div>

    <div class="container mx-auto px-4 py-8 relative z-10 min-h-screen flex flex-col">
        
        <!-- START PAGE -->
        <div id="home-page" class="flex-grow flex flex-col items-center justify-center text-center max-w-5xl mx-auto w-full">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full items-start">
                
                <!-- Info Section -->
                <div class="md:col-span-2 text-left">
                    <h1 class="neon-text text-5xl md:text-7xl mb-4 uppercase tracking-tighter">Life Processes</h1>
                    <h2 class="text-xl text-gray-400 mb-8 italic">Ranker Edition - Curated for Karun Madhav S.</h2>
                    
                    <div class="glass-card p-8 mb-10 w-full">
                        <h3 class="text-neon-green font-bold mb-4 uppercase tracking-widest text-xs">Syllabus Parameters</h3>
                        <ul class="text-left text-sm space-y-3 text-gray-300">
                            <li><span class="text-neon-green">▹</span> 25 Strictly NCERT Questions (PYQs)</li>
                            <li><span class="text-neon-green">▹</span> Global Leaderboard Active</li>
                            <li><span class="text-neon-green">▹</span> Timer: 40 Minutes</li>
                        </ul>
                    </div>
                    
                    <button onclick="openNameModal()" class="btn-start rounded-lg">INITIATE EXAM</button>
                </div>

                <!-- Leaderboard Section -->
                <div class="glass-card p-6 w-full">
                    <h3 class="text-neon-green font-bold mb-6 uppercase tracking-widest text-xs border-b border-white/10 pb-4">Global Leaderboard</h3>
                    <div id="leaderboard-list" class="space-y-3">
                        <p class="text-gray-500 text-xs animate-pulse">Establishing connection...</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- NAME MODAL -->
        <div id="name-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
            <div class="glass-card p-8 w-full max-w-md text-center border-2 border-neon-green/50">
                <h3 class="neon-text text-2xl mb-6">IDENTIFY CANDIDATE</h3>
                <p class="text-xs text-gray-500 mb-4 uppercase tracking-widest">Enter your name to proceed to the exam</p>
                <input type="text" id="user-name" 
                       placeholder="Full Name" 
                       onkeypress="if(event.key === 'Enter') validateAndStart()"
                       class="w-full bg-black/60 border border-neon-green/30 p-4 rounded-lg text-white mb-6 text-center focus:outline-none focus:border-neon-green transition-all text-xl">
                <div class="flex flex-col gap-3">
                    <button onclick="validateAndStart()" class="w-full bg-neon-green text-black font-black py-4 rounded-lg uppercase tracking-tighter hover:brightness-110 active:scale-95 transition-all">
                        START EXAMINATION
                    </button>
                    <button onclick="closeNameModal()" class="text-gray-500 text-[10px] uppercase hover:text-white transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- EXAM UI -->
        <div id="exam-ui" class="w-full max-w-6xl mx-auto flex-grow flex flex-col">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
                <div>
                    <h1 class="neon-text text-2xl uppercase">Life Processes | Ranker</h1>
                    <p id="display-candidate" class="text-gray-500 text-xs tracking-[0.2em] uppercase"></p>
                </div>
                <div class="glass-card px-8 py-3 flex items-center gap-6">
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Time Logic Remaining</p>
                        <p id="timer" class="neon-text text-2xl font-bold">40:00</p>
                    </div>
                    <button onclick="finishExam()" class="bg-red-900/30 border border-red-500 text-red-500 px-4 py-1 rounded text-xs hover:bg-red-500 hover:text-white transition">FINISH</button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 flex-grow">
                <div class="lg:col-span-1">
                    <div class="glass-card p-6 sticky top-8">
                        <h3 class="text-xs font-bold mb-6 uppercase text-gray-500">Exam Map</h3>
                        <div id="palette" class="grid grid-cols-5 gap-3"></div>
                    </div>
                </div>

                <div class="lg:col-span-3">
                    <div class="glass-card p-8 md:p-12 min-h-[500px] flex flex-col justify-between border-l-4 border-l-neon-green">
                        <div id="q-box">
                            <div class="flex justify-between items-center mb-10">
                                <span id="q-num" class="bg-neon-green text-black font-black px-4 py-1 text-xs skew-x-[-12deg]">Q-01</span>
                            </div>
                            <h2 id="q-text" class="text-xl md:text-2xl font-light leading-relaxed mb-12 text-white"></h2>
                            <div id="opt-box" class="space-y-4"></div>
                        </div>

                        <div class="flex justify-between items-center mt-12 pt-8 border-t border-gray-900">
                            <button id="prev-btn" onclick="prevQ()" class="text-gray-500 hover:text-white text-sm uppercase tracking-widest">Back</button>
                            <button id="next-btn" onclick="nextQ()" class="btn-start !py-2 !px-8 text-sm">Proceed</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS -->
        <div id="results-screen" class="max-w-4xl mx-auto w-full">
            <div class="glass-card p-10 text-center">
                <h2 class="neon-text text-4xl mb-2 uppercase">Score Report</h2>
                <p id="res-candidate" class="text-gray-400 mb-8 uppercase tracking-widest"></p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 my-12">
                    <div class="p-6 bg-black/40 rounded-xl border border-gray-800">
                        <p class="text-[10px] uppercase text-gray-500 mb-2">Result</p>
                        <p id="res-score" class="text-3xl font-bold text-neon-green"></p>
                    </div>
                    <div class="p-6 bg-black/40 rounded-xl border border-gray-800">
                        <p class="text-[10px] uppercase text-gray-500 mb-2">Time Used</p>
                        <p id="res-time-taken" class="text-3xl font-bold text-white"></p>
                    </div>
                </div>
                <div id="error-log" class="text-left space-y-4"></div>
                <button onclick="location.reload()" class="btn-start mt-12">BACK TO HUB</button>
            </div>
        </div>
    </div>

    <script>
        const questions = [
            { q: "What is the function of the 'Mucus' secreted by the gastric glands in the stomach?", o: ["To digest proteins", "To protect the inner lining of the stomach from HCl", "To kill bacteria in the food", "To digest fats"], a: 1 },
            { q: "The movement of food in the phloem is called:", o: ["Transpiration", "Translocation", "Evaporation", "Respiration"], a: 1 },
            { q: "Which of the following describes the correct path of blood from the body back to the lungs?", o: ["Vena Cava -> Right Atrium -> Right Ventricle -> Pulmonary Artery", "Vena Cava -> Left Atrium -> Left Ventricle -> Pulmonary Artery", "Pulmonary Vein -> Left Atrium -> Left Ventricle -> Aorta", "Vena Cava -> Right Atrium -> Right Ventricle -> Pulmonary Vein"], a: 0 },
            { q: "The opening and closing of stomatal pores is a function of:", o: ["Oxygen", "Temperature", "Guard cells", "Chlorophyll"], a: 2 },
            { q: "Bile juice is stored in which organ?", o: ["Liver", "Pancreas", "Gall bladder", "Small Intestine"], a: 2 },
            { q: "In which part of the human alimentary canal is food finally digested?", o: ["Stomach", "Mouth", "Large Intestine", "Small Intestine"], a: 3 },
            { q: "Which nitrogenous waste is removed by the kidneys from the blood?", o: ["Ammonia", "Urea", "Uric Acid", "Carbon Dioxide"], a: 1 },
            { q: "Which enzyme is found in the saliva that breaks down starch?", o: ["Pepsin", "Trypsin", "Salivary Amylase", "Lipase"], a: 2 },
            { q: "During vigorous physical exercise, lactic acid is formed from pyruvate in our muscle cells. This process occurs in the:", o: ["Mitochondria", "Cytoplasm", "Chloroplast", "Nucleus"], a: 1 },
            { q: "The structural and functional unit of the kidney is:", o: ["Neuron", "Nephron", "Alveoli", "Villi"], a: 1 },
            { q: "Identify the correct sequence of the human respiratory system:", o: ["Nostrils -> Pharynx -> Larynx -> Trachea -> Alveoli", "Nostrils -> Larynx -> Pharynx -> Trachea -> Alveoli", "Nostrils -> Trachea -> Pharynx -> Larynx -> Alveoli", "Nostrils -> Alveoli -> Trachea -> Larynx"], a: 0 },
            { q: "The autotrophic mode of nutrition requires:", o: ["Carbon dioxide and water", "Chlorophyll", "Sunlight", "All of the above"], a: 3 },
            { q: "What is the role of 'Emulsification' in digestion?", o: ["Digestion of proteins", "Breaking down large fat globules into smaller ones", "Conversion of glucose to glycogen", "Absorption of water"], a: 1 },
            { q: "In 'double circulation', why does the blood enter the heart twice during one cycle?", o: ["To increase speed", "To keep oxygenated and deoxygenated blood separate", "To clean the blood", "To rest the heart"], a: 1 },
            { q: "The upward movement of water and minerals in a plant is mainly driven by:", o: ["Photosynthesis", "Transpiration pull", "Translocation", "Respiration"], a: 1 },
            { q: "Protein digestion starts in which part of the body?", o: ["Mouth", "Stomach", "Small Intestine", "Large Intestine"], a: 1 },
            { q: "The breakdown of pyruvate to give CO2, water and energy happens in:", o: ["Cytoplasm", "Mitochondria", "Chloroplast", "Nucleus"], a: 1 },
            { q: "Villi are present in the small intestine to:", o: ["Secrete enzymes", "Increase surface area for absorption", "Store waste", "Move food"], a: 1 },
            { q: "Blood pressure is higher in ____ than in ____.", o: ["Veins, Arteries", "Arteries, Veins", "Capillaries, Arteries", "Atria, Ventricles"], a: 1 },
            { q: "Which valve is present between the left atrium and left ventricle?", o: ["Tricuspid valve", "Bicuspid (Mitral) valve", "Semilunar valve", "Aortic valve"], a: 1 },
            { q: "A basic event in photosynthesis is the 'Photolysis of Water'. What does it release?", o: ["CO2", "Oxygen", "Glucose", "Starch"], a: 1 },
            { q: "The mode of nutrition in Amoeba is:", o: ["Saprotrophic", "Holozoic", "Parasitic", "Autotrophic"], a: 1 },
            { q: "In plants, Phloem transports:", o: ["Water", "Minerals", "Amino acids and Sugars", "Oxygen"], a: 2 },
            { q: "Which of the following is the first step of photosynthesis?", o: ["Reduction of CO2", "Absorption of light energy by chlorophyll", "Splitting of water", "Formation of carbohydrates"], a: 1 },
            { q: "The yellow color of urine is due to the presence of:", o: ["Urea", "Uric Acid", "Urochrome", "Bilirubin"], a: 2 }
        ];

        let currentIdx = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let timeLeft = 40 * 60;
        let timerId;
        let candidateName = "";

        function openNameModal() {
            document.getElementById('name-modal').style.display = 'flex';
            document.getElementById('user-name').focus();
        }

        function closeNameModal() {
            document.getElementById('name-modal').style.display = 'none';
        }

        function validateAndStart() {
            const nameInput = document.getElementById('user-name');
            const name = nameInput.value.trim();
            if (name.length < 2) {
                nameInput.style.borderColor = 'red';
                setTimeout(() => nameInput.style.borderColor = '', 2000);
                return;
            }
            candidateName = name;
            closeNameModal();
            startExam();
        }

        function startExam() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('exam-ui').style.display = 'flex';
            document.getElementById('display-candidate').innerText = `Candidate: ${candidateName}`;
            renderPalette();
            showQuestion(0);
            startTimer();
        }

        function renderPalette() {
            const pal = document.getElementById('palette');
            pal.innerHTML = '';
            questions.forEach((_, i) => {
                const b = document.createElement('div');
                b.className = 'palette-btn bg-[#111]';
                b.id = `pal-${i}`;
                b.innerText = (i + 1);
                b.onclick = () => showQuestion(i);
                pal.appendChild(b);
            });
        }

        function showQuestion(idx) {
            currentIdx = idx;
            document.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`pal-${idx}`).classList.add('active');

            const q = questions[idx];
            document.getElementById('q-num').innerText = `Q-${(idx + 1).toString().padStart(2, '0')}`;
            document.getElementById('q-text').innerText = q.q;

            const optBox = document.getElementById('opt-box');
            optBox.innerHTML = '';
            q.o.forEach((opt, i) => {
                const card = document.createElement('div');
                card.className = `option-card p-5 rounded-xl flex items-center gap-5 cursor-pointer ${userAnswers[idx] === i ? 'selected' : ''}`;
                card.innerHTML = `<div class="w-6 h-6 border border-gray-600 rounded-full flex items-center justify-center text-[10px]">${i+1}</div><span>${opt}</span>`;
                card.onclick = () => {
                    userAnswers[idx] = i;
                    document.getElementById(`pal-${idx}`).classList.add('answered');
                    showQuestion(idx);
                };
                optBox.appendChild(card);
            });
            document.getElementById('prev-btn').style.visibility = idx === 0 ? 'hidden' : 'visible';
            document.getElementById('next-btn').innerText = idx === questions.length - 1 ? 'FINISH' : 'PROCEED';
        }

        function nextQ() {
            if (currentIdx < questions.length - 1) showQuestion(currentIdx + 1);
            else finishExam();
        }

        function prevQ() {
            if (currentIdx > 0) showQuestion(currentIdx - 1);
        }

        function startTimer() {
            timerId = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) finishExam();
            }, 1000);
        }

        function finishExam() {
            clearInterval(timerId);
            const totalTimeSec = (40 * 60) - timeLeft;
            const mTaken = Math.floor(totalTimeSec / 60);
            const sTaken = totalTimeSec % 60;
            const timeStr = `${mTaken}m ${sTaken}s`;

            let correct = 0;
            const log = document.getElementById('error-log');
            log.innerHTML = '<h3 class="text-neon-green font-bold border-b border-gray-800 pb-2 mb-4">MISTAKE LOG</h3>';

            questions.forEach((q, i) => {
                if (userAnswers[i] === q.a) {
                    correct++;
                } else {
                    const div = document.createElement('div');
                    div.className = "p-4 bg-white/5 rounded-lg border-l-2 border-red-500 text-sm";
                    div.innerHTML = `<p class="text-gray-300">Q${i+1}: ${q.q}</p><p class="text-green-400">Correct: ${q.o[q.a]}</p>`;
                    log.appendChild(div);
                }
            });

            document.getElementById('exam-ui').style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            document.getElementById('res-candidate').innerText = candidateName;
            document.getElementById('res-score').innerText = `${correct}/25`;
            document.getElementById('res-time-taken').innerText = timeStr;

            if (window.submitToLeaderboard) {
                window.submitToLeaderboard(candidateName, correct, totalTimeSec, timeStr);
            }
        }
    </script>
</body>
</html>